{% extends "base.html" %}

{% block title %}Relatório de Serviços - Lantercar{% endblock %}

{% block page_title %}Relatório de Serviços{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <a href="{{ url_for('relatorios.servicos_excel', **filtros) }}" class="btn btn-success">
        <i class="bi bi-file-excel"></i> Exportar Excel
    </a>
    <a href="{{ url_for('relatorios.servicos_pdf', **filtros) }}" class="btn btn-danger">
        <i class="bi bi-file-pdf"></i> Exportar PDF
    </a>
    <a href="{{ url_for('relatorios.index') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Voltar
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Filtros -->
<div class="card mb-3">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="bi bi-funnel"></i> Filtros
        </h6>
    </div>
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label for="data_inicio" class="form-label">Data Início</label>
                <input type="date" class="form-control" id="data_inicio" name="data_inicio" 
                       value="{{ filtros.data_inicio or '' }}">
            </div>
            <div class="col-md-3">
                <label for="data_fim" class="form-label">Data Fim</label>
                <input type="date" class="form-control" id="data_fim" name="data_fim" 
                       value="{{ filtros.data_fim or '' }}">
            </div>
            <div class="col-md-3">
                <label for="cliente_id" class="form-label">Cliente</label>
                <select class="form-select" id="cliente_id" name="cliente_id">
                    <option value="">Todos os clientes</option>
                    {% for cliente in clientes %}
                    <option value="{{ cliente.id }}" {{ 'selected' if filtros.cliente_id == cliente.id|string }}>
                        {{ cliente.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" name="status">
                    <option value="">Todos os status</option>
                    <option value="em_andamento" {{ 'selected' if filtros.status == 'em_andamento' }}>Em Andamento</option>
                    <option value="concluido" {{ 'selected' if filtros.status == 'concluido' }}>Concluído</option>
                    <option value="cancelado" {{ 'selected' if filtros.status == 'cancelado' }}>Cancelado</option>
                </select>
            </div>
            <div class="col-12">
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Aplicar Filtros
                    </button>
                    <a href="{{ url_for('relatorios.servicos') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-x"></i> Limpar Filtros
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Estatísticas -->
<div class="row mb-3">
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-primary">{{ estatisticas.total_servicos }}</h5>
                <p class="card-text small">Total de Serviços</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-success">R$ {{ "%.2f"|format(estatisticas.valor_total) }}</h5>
                <p class="card-text small">Valor Total</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-success">{{ estatisticas.servicos_concluidos }}</h5>
                <p class="card-text small">Concluídos</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-info">{{ estatisticas.servicos_em_andamento }}</h5>
                <p class="card-text small">Em Andamento</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-danger">{{ estatisticas.servicos_cancelados }}</h5>
                <p class="card-text small">Cancelados</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <div class="btn-group-vertical w-100">
                    <a href="{{ url_for('relatorios.servicos_excel', **filtros) }}" 
                       class="btn btn-sm btn-success">
                        <i class="bi bi-file-excel"></i> Excel
                    </a>
                    <a href="{{ url_for('relatorios.servicos_pdf', **filtros) }}" 
                       class="btn btn-sm btn-danger">
                        <i class="bi bi-file-pdf"></i> PDF
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lista de serviços -->
<div class="card">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="bi bi-list"></i> Serviços Encontrados ({{ ordens|length }})
        </h6>
    </div>
    <div class="card-body">
        {% if ordens %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Ordem</th>
                        <th>Cliente</th>
                        <th>Orçamento</th>
                        <th>Data Início</th>
                        <th>Data Conclusão</th>
                        <th>Status</th>
                        <th>Valor Total</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ordem in ordens %}
                    <tr>
                        <td><code>{{ ordem.numero_ordem }}</code></td>
                        <td>
                            <a href="{{ url_for('clientes.visualizar', id=ordem.orcamento.cliente.id) }}">
                                {{ ordem.orcamento.cliente.nome }}
                            </a>
                        </td>
                        <td>
                            <a href="{{ url_for('orcamentos.visualizar', id=ordem.orcamento.id) }}">
                                {{ ordem.orcamento.numero_orcamento }}
                            </a>
                        </td>
                        <td>{{ ordem.data_inicio.strftime('%d/%m/%Y') }}</td>
                        <td>
                            {% if ordem.data_conclusao %}
                                {{ ordem.data_conclusao.strftime('%d/%m/%Y') }}
                            {% else %}
                                <span class="text-muted">Em andamento</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if ordem.status == 'em_andamento' %}
                                <span class="badge bg-info">Em Andamento</span>
                            {% elif ordem.status == 'concluido' %}
                                <span class="badge bg-success">Concluído</span>
                            {% else %}
                                <span class="badge bg-danger">Cancelado</span>
                            {% endif %}
                        </td>
                        <td><strong>R$ {{ "%.2f"|format(ordem.orcamento.valor_total) }}</strong></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('ordens.visualizar', id=ordem.id) }}" 
                                   class="btn btn-outline-info" title="Visualizar">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="{{ url_for('ordens.gerar_pdf_ordem', id=ordem.id) }}" 
                                   class="btn btn-outline-primary" title="PDF da Ordem">
                                    <i class="bi bi-file-pdf"></i>
                                </a>
                                {% if ordem.nota_fiscal %}
                                <a href="{{ url_for('notas_fiscais.gerar_pdf', id=ordem.nota_fiscal.id) }}" 
                                   class="btn btn-outline-success" title="PDF da Nota Fiscal">
                                    <i class="bi bi-receipt"></i>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="bi bi-search display-1 text-muted"></i>
            <h5 class="mt-3">Nenhum serviço encontrado</h5>
            <p class="text-muted">
                Nenhum serviço foi encontrado com os filtros aplicados. 
                Tente ajustar os filtros ou remover algumas restrições.
            </p>
            <a href="{{ url_for('relatorios.servicos') }}" class="btn btn-primary">
                <i class="bi bi-arrow-clockwise"></i> Limpar Filtros
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

